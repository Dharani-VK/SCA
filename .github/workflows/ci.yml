name: API & Frontend CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build_and_test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    # ----------------------------------------------------------------
    # BACKEND
    # ----------------------------------------------------------------
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r backend/requirements.txt

    - name: Syntax Check (Python)
      run: |
        # Fails if any byte-compilation error (syntax error) is found
        python -m compileall backend/app

    - name: Start Backend & Health Check
      env:
        IS_DEMO_MODE: true
        APP_SECRET_KEY: ci_secret_test
        DATABASE_URL: sqlite:///test_ci.db
      run: |
        cd backend
        # Start uvicorn in background
        nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > ../backend.log 2>&1 &
        pid=$!
        echo "Backend started with PID $pid"
        
        # Wait for server to be ready
        echo "Waiting for backend..."
        sleep 10
        
        # Check Health Endpoint
        echo "Checking health..."
        curl -f http://127.0.0.1:8000/health || (echo "Health check failed. Backend logs:" && cat ../backend.log && exit 1)
        
        # Cleanup
        kill $pid

    # ----------------------------------------------------------------
    # FRONTEND
    # ----------------------------------------------------------------
    - name: Set up Node.js 18
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install Frontend Dependencies
      run: |
        cd frontend
        npm install

    - name: Build Frontend
      run: |
        cd frontend
        npm run build
      env:
        # Avoid treating warnings as errors in CI if strictly compiled
        CI: false 
